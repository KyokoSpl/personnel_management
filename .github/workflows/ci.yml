name: CI - Build, Format, and Test

on:
  push:
    branches: [main, develop, master]
  pull_request:
    branches: [main, develop, master]
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  QT_VERSION: "6.5.3"

jobs:
  # ===========================================
  # Code Formatting Check
  # ===========================================
  format-check:
    name: Check Code Formatting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-14

      - name: Check C++ formatting
        run: |
          FAILED=0
          while IFS= read -r file; do
            if ! clang-format-14 --dry-run --Werror "$file" 2>/dev/null; then
              echo "::error file=$file::File needs formatting"
              FAILED=1
            fi
          done < <(find src include -name "*.cpp" -o -name "*.h" 2>/dev/null || true)

          if [ "$FAILED" -eq 1 ]; then
            echo ""
            echo "::error::Code formatting issues detected. Run './scripts/format.sh' locally to fix."
            exit 1
          fi
          echo "All files are properly formatted!"

  # ===========================================
  # Linux Build and Test
  # ===========================================
  build-linux:
    name: Build and Test (Linux)
    runs-on: ubuntu-latest
    needs: format-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          modules: "qtshadertools"
          cache: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libgl1-mesa-dev libxkbcommon-dev

      - name: Create .env file
        run: cp .env.test .env || echo "No .env.test file"

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DBUILD_TESTING=ON

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} -j$(nproc)

      - name: Run tests
        working-directory: build
        run: ctest --output-on-failure --verbose -C ${{ env.BUILD_TYPE }}

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: personnel-management-linux
          path: build/personnel_management
          if-no-files-found: error

  # ===========================================
  # Windows Build
  # ===========================================
  build-windows:
    name: Build (Windows)
    runs-on: windows-latest
    needs: format-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: windows
          target: desktop
          arch: win64_msvc2019_64
          modules: "qtshadertools"
          cache: true

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Setup MSVC Environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Create .env file
        run: |
          if (Test-Path .env.test) { Copy-Item .env.test .env }
        shell: pwsh

      - name: Configure CMake
        run: |
          cmake -B build `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DBUILD_TESTING=OFF `
            -DCMAKE_PREFIX_PATH="$env:Qt6_DIR"
        shell: pwsh

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: List build output
        run: |
          Write-Host "Build directory contents:"
          Get-ChildItem -Path build -Recurse -Include *.exe | ForEach-Object { Write-Host $_.FullName }
        shell: pwsh

      - name: Prepare Windows package
        run: |
          $exePath = Get-ChildItem -Path build -Recurse -Filter "personnel_management.exe" | Select-Object -First 1
          if ($exePath) {
            $outputDir = "build/package"
            New-Item -ItemType Directory -Force -Path $outputDir
            Copy-Item $exePath.FullName -Destination $outputDir

            # Copy QML files
            if (Test-Path "build/resources/qml") {
              Copy-Item -Path "build/resources/qml" -Destination "$outputDir/resources/qml" -Recurse -Force
            } elseif (Test-Path "build/${{ env.BUILD_TYPE }}/resources/qml") {
              Copy-Item -Path "build/${{ env.BUILD_TYPE }}/resources/qml" -Destination "$outputDir/resources/qml" -Recurse -Force
            } elseif (Test-Path "resources/qml") {
              Copy-Item -Path "resources/qml" -Destination "$outputDir/resources/qml" -Recurse -Force
            }

            Write-Host "Package contents:"
            Get-ChildItem -Path $outputDir -Recurse
          } else {
            Write-Host "::error::Could not find personnel_management.exe"
            exit 1
          }
        shell: pwsh

      - name: Run windeployqt
        run: |
          $exePath = Get-ChildItem -Path "build/package" -Filter "personnel_management.exe" | Select-Object -First 1
          if ($exePath) {
            # Find windeployqt - it's in the Qt bin directory
            $qtRoot = "$env:RUNNER_WORKSPACE/Qt/$env:QT_VERSION/msvc2019_64"
            $windeployqt = "$qtRoot/bin/windeployqt.exe"

            if (-not (Test-Path $windeployqt)) {
              # Try alternative path
              $windeployqt = Get-ChildItem -Path "$env:RUNNER_WORKSPACE/Qt" -Recurse -Filter "windeployqt.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($windeployqt) { $windeployqt = $windeployqt.FullName }
            }

            if (Test-Path $windeployqt) {
              Write-Host "Using windeployqt: $windeployqt"
              & $windeployqt `
                --qmldir resources/qml `
                --no-translations `
                --no-system-d3d-compiler `
                --no-opengl-sw `
                $exePath.FullName
              Write-Host "windeployqt completed"
            } else {
              Write-Host "::warning::windeployqt not found, skipping Qt deployment"
              Write-Host "Searched in: $env:RUNNER_WORKSPACE/Qt"
              Get-ChildItem -Path "$env:RUNNER_WORKSPACE/Qt" -Recurse -Include "*.exe" | Select-Object -First 20
            }
          }
        shell: pwsh

      - name: Create NSIS installer script
        run: |
          # Extract version from CMakeLists.txt
          $cmakeContent = Get-Content "CMakeLists.txt" -Raw
          if ($cmakeContent -match 'project\s*\(\s*personnel_management\s+VERSION\s+(\d+\.\d+\.\d+)') {
            $appVersion = $matches[1]
          } else {
            $appVersion = "0.0.0"
          }
          Write-Host "Detected version: $appVersion"
          
          @"
          !define APP_NAME "Personnel Management"
          !define APP_VERSION "$appVersion"
          !define PUBLISHER "LF11A Project"
          !define WEB_SITE "https://github.com/kyokospl/personnel-management"
          !define APP_EXE "personnel_management.exe"
          !define INSTALL_DIR "`$PROGRAMFILES64\Personnel Management"
          
          Name "`${APP_NAME}"
          OutFile "personnel-management-setup.exe"
          InstallDir "`${INSTALL_DIR}"
          InstallDirRegKey HKLM "Software\`${APP_NAME}" "InstallDir"
          RequestExecutionLevel admin
          
          !include "MUI2.nsh"
          
          !define MUI_ABORTWARNING
          !define MUI_ICON "`${NSISDIR}\Contrib\Graphics\Icons\modern-install.ico"
          !define MUI_UNICON "`${NSISDIR}\Contrib\Graphics\Icons\modern-uninstall.ico"
          
          !insertmacro MUI_PAGE_WELCOME
          !insertmacro MUI_PAGE_LICENSE "LICENSE"
          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          !insertmacro MUI_PAGE_FINISH
          
          !insertmacro MUI_UNPAGE_CONFIRM
          !insertmacro MUI_UNPAGE_INSTFILES
          
          !insertmacro MUI_LANGUAGE "English"
          
          Section "MainSection" SEC01
            SetOutPath "`$INSTDIR"
            SetOverwrite ifnewer
            
            File /r "build\package\*.*"
            
            CreateDirectory "`$SMPROGRAMS\`${APP_NAME}"
            CreateShortCut "`$SMPROGRAMS\`${APP_NAME}\`${APP_NAME}.lnk" "`$INSTDIR\`${APP_EXE}"
            CreateShortCut "`$DESKTOP\`${APP_NAME}.lnk" "`$INSTDIR\`${APP_EXE}"
            
            WriteRegStr HKLM "Software\`${APP_NAME}" "InstallDir" "`$INSTDIR"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}" "DisplayName" "`${APP_NAME}"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}" "UninstallString" "`$INSTDIR\uninstall.exe"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}" "DisplayIcon" "`$INSTDIR\`${APP_EXE}"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}" "Publisher" "`${PUBLISHER}"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}" "DisplayVersion" "`${APP_VERSION}"
            
            WriteUninstaller "`$INSTDIR\uninstall.exe"
          SectionEnd
          
          Section "Uninstall"
            Delete "`$INSTDIR\uninstall.exe"
            Delete "`$DESKTOP\`${APP_NAME}.lnk"
            Delete "`$SMPROGRAMS\`${APP_NAME}\*.*"
            RMDir "`$SMPROGRAMS\`${APP_NAME}"
            
            RMDir /r "`$INSTDIR"
            
            DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}"
            DeleteRegKey HKLM "Software\`${APP_NAME}"
          SectionEnd
          "@ | Out-File -FilePath "installer.nsi" -Encoding ASCII
          
          Write-Host "NSIS script created"
        shell: pwsh

      - name: Build Windows installer
        run: |
          # Install NSIS using Chocolatey
          choco install nsis -y
          
          # Refresh environment to get NSIS in PATH
          $env:PATH = [System.Environment]::GetEnvironmentVariable("PATH","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("PATH","User")
          
          # Build the installer
          & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi
          
          if (Test-Path "personnel-management-setup.exe") {
            Write-Host "Installer created successfully"
            New-Item -ItemType Directory -Force -Path "build/installer"
            Move-Item "personnel-management-setup.exe" "build/installer/"
          } else {
            Write-Host "::error::Failed to create installer"
            exit 1
          }
        shell: pwsh

      - name: Upload Windows installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: personnel-management-windows
          path: build/installer/personnel-management-setup.exe
          if-no-files-found: error

  # ===========================================
  # macOS Build
  # ===========================================
  build-macos:
    name: Build (macOS)
    runs-on: macos-latest
    needs: format-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          modules: "qtshadertools"
          cache: true

      - name: Install dependencies
        run: brew install cmake ninja

      - name: Create .env file
        run: cp .env.test .env || echo "No .env.test file"

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DBUILD_TESTING=ON

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      - name: Run tests
        working-directory: build
        run: ctest --output-on-failure --verbose -C ${{ env.BUILD_TYPE }}

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: personnel-management-macos
          path: build/personnel_management
          if-no-files-found: warn

  # ===========================================
  # Build Summary
  # ===========================================
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    if: always()

    steps:
      - name: Check build status
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux    | ${{ needs.build-linux.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows  | ${{ needs.build-windows.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS    | ${{ needs.build-macos.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any build failed
        if: |
          needs.build-linux.result == 'failure' ||
          needs.build-windows.result == 'failure'
        run: |
          echo "One or more builds failed!"
          exit 1
